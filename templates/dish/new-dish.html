<!DOCTYPE html>
<html lang="en" class="scroll-smooth">

{{ template "header" . }}

<body class="bg-gray-50">

  	{{ template "navbar" . }}

	<!-- Lista com modais -->
	{{ template "modal-dish-name" . }}
	{{ template "modal-dish-description" . }}
	{{ template "modal-dish-price" . }}
	{{ template "modal-dish-section" . }}
	{{ template "modal-dish-weekdays" . }}
	{{ template "modal-dish-time" . }}
	{{ template "modal-dish-uploadimages" . }}
	{{ template "modal-dish-pick-images" . }}
	<!-- Fim da lista com modais -->

	<!-- Resumo do prato -->
	<form action="dish/new" class="min-h-[60vh] flex flex-col justify-between mb-32" method="post">
		<div class="max-w-4xl mx-auto p-4 sm:p-6 lg:p-8 flex-1"></div>
			<h3 class="text-xl font-semibold text-gray-900 mb-4 text-center">Novo Prato</h3>
			<div class="bg-white shadow-sm rounded-lg p-4 sm:p-6 lg:p-8">
				<div class="space-y-2">

					<!-- Usuário e empresa -->
					<input id="CompanyID" name="CompanyID" type="number" value="{{ .CompanyID }}" hidden>
					<input id="UserID" name="UserID" type="number" value="{{ .UserID }}" hidden>
					<!-- Hidden fallback for Active (0 = false, 1 = true). Updated by JS in updateSummary() -->
					<input id="ActiveHidden" name="Active" type="hidden" value="0">
					<!-- Fim de usuário/empresa -->
					<!-- Nome do prato -->
					<div id="summary-name-container" class="flex flex-col w-full">
						<div>
							<button type="button" onclick="openModal('modal_dish_name')" class="text-lg text-blue-900 w-full text-left">Editar Nome do Prato</button>
						</div>
						<div class="flex items-center space-x-1 w-full">
							<input type="checkbox" id="summary-showname" title="showname" class="h-4 w-4 text-blue-600 focus:ring-blue-500 border-gray-300 rounded" readonly>
							<input type="text" id="summary-name" name="Name" class="mt-1 text-sm text-gray-500 w-full" placeholder="*Defina o nome do prato." readonly>
						</div>
					</div>
					<!-- Fim nome do prato -->
					<!-- Descrição do prato -->
					<div class="flex flex-col w-full">
						<div>
							<button type="button" onclick="openModal('modal_dish_description')" class="text-lg text-blue-900 w-full text-left">Editar Descrição do Prato</button>
						</div>
						<div class="flex items-center space-x-1 w-full">
							<input type="checkbox" id="summary-showdescription" name="showdescription" title="showdescription" class="h-4 w-4 text-blue-600 focus:ring-blue-500 border-gray-300 rounded" readonly>
							<input type="text" id="summary-description" name="Description" class="mt-1 text-sm text-gray-500 w-full" placeholder="Defina a descrição do prato." readonly>
						</div>
					</div>
					<!-- Fim descrição do prato -->
					<!-- Preço do prato -->
					<div class="flex flex-col w-full">
						<div>
							<button type="button" onclick="openModal('modal_dish_price')" class="text-lg text-blue-900 w-full text-left">Editar Preço do Prato</button>
						</div>
						<div class="flex items-center space-x-1 w-full">
							<input type="checkbox" id="summary-showPrice" name="showPrice" title="showPrice" class="h-4 w-4 text-blue-600 focus:ring-blue-500 border-gray-300 rounded" readonly>
							<input type="text" id="summary-price-text" name="Price-text" class="mt-1 text-sm text-gray-500 w-full" placeholder="Defina o preço do prato." readonly>
							<input id="summary-price-number" name="Price" value="1.54" hidden>
						</div>
					</div>
					<!-- Fim preço do prato -->
					<!-- Seção do prato -->
					<div id="summary-section-container" class="flex flex-col w-full">
						<div>
							<button type="button" onclick="openModal('modal_dish_section')" class="text-lg text-blue-900 w-full text-left">Editar Seção do Prato</button>
						</div>
						<div class="flex items-center space-x-1 w-full">
							<input type="text" id="summary-section" class="mt-1 text-sm text-gray-500 w-full" placeholder="Defina a seção do prato." readonly>
							<input hidden id="summary-section-id" name="SectionID" class="mt-1 text-sm text-gray-500">
						</div>
					</div>
					<!-- Fim seção do prato -->
					<!-- Dias da semana -->
					<div class="flex flex-col w-full">
						<div>
							<button type="button" onclick="openModal('modal_dish_weekdays')" class="text-lg text-blue-900 w-full text-left">Editar Dias da Semana</button>
						</div>
						<div class="flex items-center space-x-1 w-full">
							<input type="text" id="summary-weekdays" name="WeekDays" class="mt-1 text-sm text-gray-500 w-full" placeholder="Defina os dias da semana." readonly>
						</div>
					</div>
					<!-- Fim dias da semana -->
					<!-- Horário -->
					<div class="flex flex-col w-full">
						<div>
							<button type="button" onclick="openModal('modal_dish_time')" class="text-lg text-blue-900 w-full text-left">Editar Horário</button>
						</div>
						<div class="flex items-center space-x-1 w-full">
							<input type="text" id="summary-time" name="Availability" class="mt-1 text-sm text-gray-500 w-full" placeholder="Defina o horário de disponibilidade do prato." readonly>
						</div>
					</div>
					<!-- Fim horário -->
					<!-- Imagens do prato -->
					<div class="flex flex-col w-full">
						<div>
							<button type="button" onclick="openModal('modal_dish_pickimages');" class="text-lg text-blue-900 w-full text-left">Editar Imagens do Prato</button>
						</div>
						<div class="flex items-center space-x-1 w-full">
							<input type="text" id="summary-images" class="mt-1 text-sm text-gray-500 w-full" placeholder="Defina as imagens do prato." readonly>
							<input hidden="summary-images-ids" name="Images" class="mt-1 text-sm text-gray-500" value="1,3">
						</div>
					</div>
					<!-- Fim imagens do prato -->
					<!-- Botão salvar -->
					<hr class="my-4">
					<div class="flex justify-end">
						<p class="mt-1 text-sm text-gray-500">Confira as informações do prato antes de salvar.</p>
						<button type="submit" id="btn-save-dish" class="inline-flex items-center px-4 py-2 border border-transparent text-sm font-medium rounded-md shadow-sm text-white bg-green-600 hover:bg-green-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-green-500">
							Salvar
						</button>
					</div>
					<!-- Fim botão salvar -->
				</div>
			</div>
		</div>
	</form>

	{{ template "footer" . }}
</html>
</body>

<script>
	document.addEventListener('DOMContentLoaded', function() {
		console.log('Opening modal');
		//openModal('modal_dish_name');
	});

	// Atualiza o resumo do prato
	function updateSummary() {
		// Atualiza o resumo com os valores dos modais
		console.log('Updating summary...');
		// Nome e ativo
		var name = document.getElementById('modal-name').value;
		var showName = document.getElementById('modal-showname').checked;
		document.getElementById('summary-name').value = name;
		document.getElementById('summary-showname').checked = showName;
		// Update hidden Active field so the form always submits the correct value
		var activeHidden = document.getElementById('ActiveHidden');
		if (activeHidden) {
			activeHidden.value = showName ? '1' : '0';
		}
		// Descrição e mostrar descrição
		var description = document.getElementById('modal-description').value;
		var showDescription = document.getElementById('modal-showdescription').checked;
		console.log('Description:', description, 'ShowDescription:', showDescription);
		document.getElementById('summary-description').value = description ? description : 'Descrição do prato não definida.';
		document.getElementById('summary-showdescription').checked = showDescription;
		// Preço e mostrar preço
		var price = document.getElementById('modal-price').value;
		var showPrice = document.getElementById('modal-showPrice').checked;
		console.log('Price:', price, 'ShowPrice:', showPrice);
		// Considera a vírgula como divisor decimal
		price == "" ? price = "0" : price;
		if (price) {
			// Troca ponto por vírgula se necessário
			let formattedPrice = price.replace('.', ',');
			// Se já tem vírgula, mantém
			if (!formattedPrice.includes(',')) {
				// Se não tem vírgula, mas tem ponto, já foi trocado
				// Se não tem nenhum, adiciona ,00
				formattedPrice += ',00';
			} else {
				// Garante duas casas decimais
				let parts = formattedPrice.split(',');
				if (parts[1] && parts[1].length === 1) {
					formattedPrice += '0';
				}
				if (!parts[1]) {
					formattedPrice += '00';
				}
			}
			document.getElementById('summary-price-text').value = 'R$' + formattedPrice;
			document.getElementById('summary-price-number').value = parseFloat(price.replace(',', '.'));
		}
		document.getElementById('summary-showPrice').checked = showPrice;
		// Seção
		var checkedSection = document.querySelector('input[name="modal_section"]:checked');
		var section = checkedSection ? (checkedSection.title ? checkedSection.title : 'Seção do prato não definida.') : 'Seção do prato não definida.';
		var sectionid = checkedSection ? checkedSection.value : '';
		console.log('Section:', section, 'SectionID:', sectionid);
		document.getElementById('summary-section').value = section;
		document.getElementById('summary-section-id').value = sectionid;
		// Dias da semana
		var weekdays = Array.from(document.querySelectorAll('input[name="modal-weekdays"]:checked')).map(cb => cb.title);
		console.log('Weekdays:', weekdays);
		document.getElementById('summary-weekdays').value = weekdays.length > 0 ? weekdays.join(', ') : 'Dias da semana não definidos.';
		// Horário
		var time = document.getElementById('modal-selected-times').textContent;
		console.log('Time:', time);
		document.getElementById('summary-time').value = time ? time : '';
		// Imagens
		var images = Array.from(document.querySelectorAll('input[name="modal-dish-pick-images"]:checked')).map(cb => cb.value);
		console.log('Images:', images, "total selected:", images.length);
		if (images.length > 0) {
			const imageNames = images.map(img => {
				const parts = img.split('/');
				const filename = parts[parts.length - 1];
				return filename.replace(/\.[^/.]+$/, "");
			});
			document.getElementById('summary-images').value = imageNames.join(', ');

			const imageIds = Array.from(document.querySelectorAll('input[name="modal-dish-pick-images"]:checked')).map(cb => {
				return cb.id.replace('image_', '');
			});
			document.getElementById('summary-images-ids').value = imageIds.join(',');
		} else {
			document.getElementById('summary-images').value = 'Nenhuma imagem selecionada.';
		}

		// *** Esta chamada TEM que ser feita no fim do updateSummary
		// Verifica se o prato é válido para habilitar o botão de salvar
		checkDishValidity();

	};

	// Delegação de evento para delete-image (funciona para estáticos e dinâmicos)
	document.addEventListener('click', function(event) {
		const button = event.target.closest('.delete-image');
		if (button) {
			const imageId = button.getAttribute('data-image-id');
			if (confirm('Tem certeza que deseja excluir esta imagem?')) {
				console.log('Deleting image with ID:', imageId);
				fetch(`/dishes/images/delete/${imageId}`, {
					method: 'DELETE',
					headers: {
						'Content-Type': 'application/json'
					}
				})
				.then(response => response.json())
				.then(data => {
					console.log('Success:', data);
					if (data.success) {
						const imageElement = button.closest('div');
						imageElement.remove();
					} else {
						console.log('Error deleting image:', data);
						alert(data.error || 'Erro ao excluir a imagem.');
					}
				});
			}
		}
	});

	// Delegação de evento para delete-section (funciona para estáticos e dinâmicos)
	document.addEventListener('click', function(event) {
		const button = event.target.closest('.delete-section');
		if (button) {
			const sectionId = button.getAttribute('data-section-id');
			if (confirm('Tem certeza que deseja excluir esta seção?')) {
				console.log('Deleting section with ID:', sectionId);
				fetch(`/sections/delete/${sectionId}`, {
					method: 'DELETE',
					headers: {
						'Content-Type': 'application/json'
					}
				})
				.then(response => response.json())
				.then(data => {
					console.log('Success:', data);
					if (data.success) {
						const sectionElement = button.closest('div');
						sectionElement.remove();
					} else {
						console.log('Error deleting section:', data);
						alert(data.error || 'Erro ao excluir a seção.');
					}
				});
			}
		}
	});

	// Executar quando enter for pressionado em section
	document.getElementById('modal-input-section').addEventListener('keypress', function(event) {
		if (event.key === 'Enter') {
			event.preventDefault();
			let sectionDescription = document.getElementById('modal-input-section').value.trim();
			if (sectionDescription === '') {
				alert('Por favor, insira a descrição do setor.');
				return;
			}
			console.log('Creating new section:', sectionDescription);
			let CompanyID = document.getElementById('CompanyID').value;
			console.log('CompanyID:', CompanyID);
			let UserID = document.getElementById('UserID').value;
			console.log('UserID: ', UserID)
			fetch('/sections/new', {
				method: 'POST',
				headers: {
					'Content-Type': 'application/json'
				},
				body: JSON.stringify({
					"description": sectionDescription,
					"UserID": parseInt(UserID),
					"CompanyID": parseInt(CompanyID)
				})
			})
			.then(response => response.json())
			.then(data => {
				if (data.success) {
					// Adiciona a nova seção na lista de opções
					const sectionList = document.getElementById('modal-section-list');
					sectionList.insertAdjacentHTML('beforeend', data.renderedHTML);
					// Limpa o campo de entrada
					document.getElementById('modal-input-section').value = '';
				} else {
					console.log('Error creating section:', data);
					alert(data.error || 'Erro ao criar a seção.');
				}
			});
		}
	});

	// Executar quando adicionar horários for pressionado
	document.getElementById('add-times').addEventListener('click', function() {
		const selectStart = document.querySelector('.form-select-start');
		const selectEnd = document.querySelector('.form-select-end');
		const selectedTimes = document.getElementById('modal-selected-times');

		const startTime = selectStart.value;
		const endTime = selectEnd.value;

		if (startTime === 'Das' || endTime === 'Até') {
			alert('Por favor, selecione ambos os horários.');
			return;
		}

		if (startTime >= endTime) {
			alert('O horário de início deve ser anterior ao horário de término.');
			return;
		}

		const newTimeRange = `${startTime} - ${endTime}`;
		if (selectedTimes.textContent.includes(newTimeRange)) {
			alert('Este intervalo de horário já foi adicionado.');
			return;
		}
		selectedTimes.textContent += (selectedTimes.textContent ? ', ' : '') + newTimeRange;
		console.log('Added time range:', newTimeRange);
	});

	// Executar quando upload-button for pressionado
	document.getElementById('upload-button').addEventListener('click', function() {
		saveImages();
	});

	// Executar quando a classe closeModal for pressionado
	document.querySelectorAll('.closeModal').forEach(button => {
		button.addEventListener('click', function(event) {
			const clickedButton = this;
			const parentContainer = clickedButton.closest('.modal-buttons');
			const modalId = parentContainer.querySelector('.modal-identifier').textContent;
			console.log('Closing modal from', modalId);
			closeModal('modal_dish_' + modalId.toLowerCase());
			// Ao sair do modal, atualiza o resumo
			updateSummary();
		});
	});

	// Executar quando a classe nextModal for pressionado
	document.querySelectorAll('.nextModal').forEach(function(button) {
		button.addEventListener('click', function() {
			const modalId = this.closest('.modal-buttons').querySelector('span.modal-identifier').textContent;
			console.log('Next modal from', modalId);
			const nextModalElement = this.closest('.modal-buttons').querySelector('span.modal-next').textContent;
			console.log('Next modal element:', nextModalElement);
			if (nextModalElement) {
				closeModal('modal_dish_' + modalId.toLowerCase());
				openModal('modal_dish_' + nextModalElement.toLowerCase());
			} else {
				console.log('No next modal found for', modalId);
			}
		});
	});

	// Executar quando a classe prevModal for pressionado
	document.querySelectorAll('.prevModal').forEach(function(button) {
		button.addEventListener('click', function() {
			const modalId = this.closest('.modal-buttons').querySelector('.modal-identifier').textContent;
			const prevModalId = this.closest('.modal-buttons').querySelector('.modal-prev').textContent;
			if (prevModalId) {
				closeModal('modal_dish_' + modalId.toLowerCase());
				openModal('modal_dish_' + prevModalId.toLowerCase());
			} else {
				console.log('No previous modal found for', modalId);
			}
		});
	});

	// Function to save images (placeholder)
	function saveImages() {
		console.log('Saving images...');
		// Carrega os arquivos de upload-image-list
		const uploadInput = document.getElementById('upload-images');
		const uploadFiles = uploadInput.files;
		if (uploadFiles.length == 0) {
			console.log('No images selected for upload.');
			return;
		}

		// Adiciona cada arquivo ao objeto FormData
		let formData = new FormData();
		for (let i = 0; i < uploadFiles.length; i++) {
			formData.append('images[]', uploadFiles[i]);
			console.log('Added file:', uploadFiles[i].name);
		}

		// Envia os arquivos para o servidor
		fetch('images/upload-multiple-images', {
			method: 'POST',
			body: formData
		})
		.then(response => response.json())
		.then(data => {
			console.log('Success:', data);
			if (data.success) {
				// // Atualiza a lista de imagens no modal de seleção
				const imageSelection = document.getElementById('image-selection');
				imageSelection.insertAdjacentHTML('beforeend', data.renderedHTML);
				// Fecha o modal de upload
				closeModal('modal_dish_uploadimages');
				// Abre o modal de seleção de imagens
				openModal('modal_dish_pickimages');
			} else {
				console.log('Error uploading images:', data);
				alert(data.error || 'Erro ao fazer upload das imagens.');
			}
		})
		.catch(error => {
			console.error('Error:', error);
		});
	}

	// Close modal function
	window.closeModal = function(modalId) {
		console.log('Closing modal', modalId);
		const modal = document.getElementById(modalId);
		const modalContent = modal.querySelector('.modal-content');
		// Adiciona classes para animação de fechamento
		modalContent.classList.remove('scale-100', 'opacity-100');
		modalContent.classList.add('scale-95', 'opacity-0');
		modal.classList.remove('opacity-100');
		modal.classList.add('opacity-0');
		setTimeout(() => {
				modal.classList.add('invisible');
		}, 300);

		// Cria nome para função de callback
		const callbackFunctionName = modalId.replace('modal_dish_', 'modal_dish_') + '_closed';
		// Verifica se a função existe e a chama
		if (typeof window[callbackFunctionName] === 'function') {
			window[callbackFunctionName]();
		}
		else {
			console.log('No callback function found for', modalId);
		}
	};
	// Open modal function
	window.openModal = function(modalId) {
		console.log('Opening modal', modalId);
		const modal = document.getElementById(modalId);
		const modalContent = modal.querySelector('.modal-content');
		// Adiciona classes para animação de abertura
		modal.classList.remove('invisible', 'opacity-0');
		modal.classList.add('opacity-100');
		modalContent.classList.remove('scale-95', 'opacity-0');
		modalContent.classList.add('scale-100', 'opacity-100');
	};

	// Função para verificar a validade do prato
	function checkDishValidity() {
		console.log('Checking dish validity...');

		let formData = new FormData();
		formData.append('name', document.getElementById('summary-name').value.trim());
		formData.append('description', document.getElementById('summary-description').value.trim());
		formData.append('section_id', document.getElementById('summary-section-id').value.trim());

		// Verifica se o prato é válido
		fetch('dish/validate', {
			method: 'POST',
			body: formData
		})
		.then(response => response.json())
		.then(data => {
			dishValid(data);
		})
		.catch(error => {
			console.error('Error:', error);
		});
	}

	function dishValid(data) {

		console.log('Dish validity response:', data);

		if (data.valid) {
			console.log('Dish is valid.');
			// Habilita o botão de salvar
			document.getElementById('btn-save-dish').disabled = false;
		} else {
			console.log('Dish is invalid:\n' + JSON.stringify(data, null, 2));
			// Desabilita o botão de salvar
			document.getElementById('btn-save-dish').disabled = true;
		}
		
		if ( data.errors.name ) {
			console.log('Name error:', data.errors.name);
			alert(data.errors.name);
			// Change summary-name-container background to red briefly
			const nameContainer = document.getElementById('summary-name-container');
			nameContainer.classList.add('bg-red-100');
		} else {
			// Remove red background if no error
			const nameContainer = document.getElementById('summary-name-container');
			nameContainer.classList.remove('bg-red-100');
		}

		if (data.errors.section_id) {
			console.log('Section ID error:', data.errors.section_id);
			alert(data.errors.section_id);
			// Change summary-section-container background to red briefly
			const sectionContainer = document.getElementById('summary-section-container');
			sectionContainer.classList.add('bg-red-100');
		} else {
			// Remove red background if no error
			const sectionContainer = document.getElementById('summary-section-container');
			sectionContainer.classList.remove('bg-red-100');
		}
	}
</script>

